
if(!Array.prototype.indexOf){Array.prototype.indexOf=function(object){for(var i=0,length=this.length;i<length;i++)
if(this[i]==object)return i;return-1;};}
var isIE=/MSIE/.test(navigator.userAgent);if(!sn)
var sn=function(el,domAttributes,styleAttributes){if(!el){return;}
if(domAttributes){for(var i in domAttributes){var domAttribute=domAttributes[i];if(typeof(domAttribute)=="function"){continue;}
if(isIE&&i=="type"&&(el.tagName=="INPUT"||el.tagName=="SELECT")){continue;}
if(i=="className"){i="class";el.className=domAttribute;}
if(domAttribute!==el.getAttribute(i)){try{if(domAttribute===false){el.removeAttribute(i);}else{el.setAttribute(i,domAttribute);}}
catch(err){console.log("WARNING: Couldnt sn for "+el.tagName+", attr "+i+", val "+domAttribute);}}}}
if(styleAttributes){for(var i in styleAttributes){if(typeof(styleAttributes[i])=="function"){continue;}
if(el.style[i]!=styleAttributes[i]){el.style[i]=styleAttributes[i];}}}};if(!cn)
var cn=function(tag,domAttributes,styleAttributes,innerHTML){var el=document.createElement(tag);sn(el,domAttributes,styleAttributes);if(innerHTML){el.innerHTML=innerHTML;}
return el;};var GIM={elementDomFunctions:{},init:function(dbName){this.initPanel();this.initDom();this.initDatabase();this.chooseDb(dbName);},initPanel:function(){this.div_to_store_skin_sam_class=cn('div',{className:'yui-skin-sam'});document.body.appendChild(this.div_to_store_skin_sam_class);this.gim_dom_container=cn('div',{id:'gim_dom_container'});this.div_to_store_skin_sam_class.appendChild(this.gim_dom_container);var gim_dom_container_hd=document.createElement('div',{className:'hd'});this.gim_dom_container.appendChild(gim_dom_container_hd);var gim_dom_container_bd=cn('div',{className:'bd'});this.gim_dom_container.appendChild(gim_dom_container_bd);var gim_dom_container_ft=cn('div',{className:'ft'});this.gim_dom_container.appendChild(gim_dom_container_ft);this.panel_container=new YAHOO.widget.Panel('gim_panel',{width:"1150px",close:true,draggable:true,modal:true,visible:this.panel_visible});this.panel_container.setHeader('GIM : Gears In Motion, a simple tool for your gears databases !');this.panel_container.setFooter('Copyright (c) 2007, Eric Abouaf, Samuel Dehouck, Maxime R&eacute;ty - <a style="text-decoration:underline; color:blue; cursor:pointer;" onclick="GIM.showLicense();">License</a>');this.panel_container.hideEvent.subscribe(this.onHide,this,true);this.panel_container.showEvent.subscribe(this.onShow,this,true);},initDom:function(){this.gim_container=document.createElement('div');this.gim_container.id='gim-container';this.panel_container.appendToBody(this.gim_container);this.panel_container.render(this.gim_dom_container);this.panel_container.center();this.gim_menu=cn('div',{id:'gim-menu'});this.gim_container.appendChild(this.gim_menu);this.gim_page=cn('div',{id:'gim-page'});this.gim_container.appendChild(this.gim_page);this.gim_data=cn('div',{className:'gim-data'});this.gim_page.appendChild(this.gim_data);this.gim_data_belongs_to=cn('div',{className:'gim-data linked-table'});this.gim_page.appendChild(this.gim_data_belongs_to);this.gim_data_has_many=cn('div',{className:'gim-data linked-table'});this.gim_page.appendChild(this.gim_data_has_many);this.gim_data_many_to_many=cn('div',{className:'gim-data linked-table'});this.gim_page.appendChild(this.gim_data_many_to_many);},chooseDb:function(dbName){var dbToOpen=dbName;if(!dbToOpen){dbToOpen=prompt('Please enter the name of the database to open');if(dbToOpen===null)return;if(dbToOpen===""){alert("Database must have a name.");return;}}
this.openDatabase(dbToOpen);this.updateMenu();},show:function(){this.panel_container.show();},hide:function(){this.panel_container.hide();},onShow:function(){this.panel_visible=true;},onHide:function(){this.panel_visible=false;},toggle:function(){if(this.panel_visible){this.hide();}else{this.show();}},getRegExResult:function(query){var result=query.match(/^select (([^, ]*)(, [^, ]*)*) from (([^, ]*)(, [^, ]*)*)/);var fields=result[1].split(', ');var tables=result[4].split(', ');},updateMenu:function(){this.gim_menu.innerHTML="";this.gim_data.innerHTML="";this.gim_data_belongs_to.innerHTML="";this.gim_data_has_many.innerHTML="";this.gim_data_many_to_many.innerHTML="";new YAHOO.widget.Button({label:"Change database",id:"buttonChangeDB",container:this.gim_menu,onclick:{fn:function(){GIM.chooseDb();}}});this.gim_menu.appendChild(cn('p',null,null,"Database: <b>"+this.openedDatabase+"</b>"));var tables=this.listTables();var tableEl=cn('table',{className:'gim-db-tables-display yui-dt-table'});var thead=document.createElement('thead');var tr=document.createElement('tr');var thName=cn('th',{colSpan:2},null,"Tables :");tr.appendChild(thName);thead.appendChild(tr);tableEl.appendChild(thead);var tbody=document.createElement('tbody');for(var i=0;i<tables.length;i++){var tableProp=tables[i];var lineClass=(i%2===0)?"yui-dt-even":"yui-dt-odd";tr=cn('tr',{className:lineClass});tr.tableName=tableProp.name;var tdName=cn('td',null,null,tableProp.name);tr.appendChild(tdName);tdName.title=GIM.countTable(tableProp.name)+" elements in "+tableProp.name;YAHOO.util.Dom.addClass(tdName,'gim-db-table-link');var tdOperations=cn('td',{className:'gim-db-drop-link'},null,"&nbsp;");tr.appendChild(tdOperations);YAHOO.util.Event.addListener(tdName,'click',function(){GIM.displayTableBySql("select * from "+this.parentNode.tableName,[],GIM.gim_data,this.parentNode.tableName);});YAHOO.util.Event.addListener(tdName,'click',function(){GIM.gim_data_belongs_to.innerHTML="";GIM.gim_data_has_many.innerHTML="";GIM.gim_data_many_to_many.innerHTML="";YAHOO.util.Dom.setStyle(GIM.gim_data_belongs_to,'display','none');YAHOO.util.Dom.setStyle(GIM.gim_data_has_many,'display','none');YAHOO.util.Dom.setStyle(GIM.gim_data_many_to_many,'display','none');});YAHOO.util.Event.addListener(tdOperations,'click',function(){if(confirm('Drop table '+this.parentNode.tableName+' ?')){GIM.dropTable(this.parentNode.tableName);GIM.updateMenu();}});tbody.appendChild(tr);}
tableEl.appendChild(tbody);this.gim_menu.appendChild(tableEl);new YAHOO.widget.Button({label:"Add a table",id:"buttonCreateTable",container:this.gim_menu,onclick:{fn:this.addTable,scope:this}});new YAHOO.widget.Button({label:"Export",id:"buttonExportSql",container:this.gim_menu,onclick:{fn:this.exportSql,scope:this}});var msg=cn('p',{className:'gim-message'},null,"Please visit <a href='http://code.google.com/p/gearsinmotion/' target='_new'>the GIM website</a> for any comment, bug report or feature request.");this.gim_menu.appendChild(msg);},displayTableBySql:function(query,queryParams,container,tableName){if(GIM._dataTableBySql&&GIM._dataTableBySql.contextMenu){GIM._dataTableBySql.contextMenu.destroy();GIM._dataTableBySql.contextMenu=null;}
GIM._dataTableBySql=new GIM.DataTableBySql(query,queryParams,container,tableName);},viewElement:function(id,tableName){var result=this.query('select * from '+tableName+' where id=?',[id])[0];if(YAHOO.lang.isFunction(GIM.elementDomFunctions[tableName])){var f=GIM.elementDomFunctions[tableName];this.gim_data.innerHTML="";this.gim_data.appendChild(f(result));}
else{new GIM.DataTableBySql('select * from '+tableName+' where id=?',[id],this.gim_data,tableName);}
GIM._dataTableBySql_manytomany=[];GIM._dataTableBySql_hasmany=[];GIM._dataTableBySql_belongsto=[];this.gim_data_many_to_many.innerHTML="";this.gim_data_has_many.innerHTML="";this.gim_data_belongs_to.innerHTML="";YAHOO.util.Dom.setStyle(this.gim_data_many_to_many,'display','block');YAHOO.util.Dom.setStyle(this.gim_data_has_many,'display','block');YAHOO.util.Dom.setStyle(this.gim_data_belongs_to,'display','block');var setTitleFlag=[false,false,false];var divContainer;if(this.liaisons[tableName]){for(var i=0;i<this.liaisons[tableName].length;i++){var relation=this.liaisons[tableName][i][0];var destTable=this.liaisons[tableName][i][1];if(relation=="many_to_many"){var liaisonTableName=this.liaisons[tableName][i][2];var linked_elts=GIM.query("select "+this.singularizeTableName(destTable)+"_id from "+liaisonTableName+" where "+this.singularizeTableName(tableName)+"_id=?",[id]);if(linked_elts.length>0){setTitleFlag[0]=true;var title=cn("div",{className:'linked-elts-title'},null,"Elements linked through link table "+liaisonTableName);divContainer=document.createElement('div');this.gim_data_many_to_many.appendChild(title);this.gim_data_many_to_many.appendChild(divContainer);var query="select * from "+destTable+' where ';paramsTab=[];for(var j=0;j<linked_elts.length;j++){for(var link_id in linked_elts[j]){if(linked_elts[j].hasOwnProperty(link_id)){paramsTab.push(destTable+'.id='+linked_elts[j][link_id]);}}}
query+=paramsTab.join(" or ");GIM._dataTableBySql_manytomany.push(new GIM.DataTableBySql(query,[],divContainer,destTable));}}
var destTableFieldsForQuery=destTable+'.'+(GIM.listFieldInTable(destTable)[1].join(','+destTable+'.'));if(relation=="has_many"){setTitleFlag[1]=true;divContainer=document.createElement('div');this.gim_data_has_many.appendChild(divContainer);GIM._dataTableBySql_hasmany.push(new GIM.DataTableBySql('select '+destTableFieldsForQuery+' from '+destTable+', '+tableName+' where '+destTable+'.'+this.singularizeTableName(tableName)+'_id='+tableName+'.id and '+tableName+'.id=?',[id],divContainer,destTable));}
if(relation=="belongs_to"){setTitleFlag[2]=true;divContainer=document.createElement('div');this.gim_data_belongs_to.appendChild(divContainer);GIM._dataTableBySql_belongsto.push(new GIM.DataTableBySql('select '+destTableFieldsForQuery+' from '+destTable+', '+tableName+' where '+destTable+'.id='+tableName+'.'+this.singularizeTableName(destTable)+'_id and '+tableName+'.id=?',[id],divContainer,destTable));}}}
var title,childNodes;var titlesData=[[this.gim_data_many_to_many,'MANY TO MANY'],[this.gim_data_has_many,'HAS_MANY'],[this.gim_data_belongs_to,'BELONGS_TO']];for(var i=0;i<titlesData.length;i++){if(setTitleFlag[i]){title=cn('h2',{className:'linked-elts-title'},null,titlesData[i][1]);childNodes=titlesData[i][0].childNodes;YAHOO.util.Dom.insertBefore(title,childNodes[0]);}}},exportSql:function(){var sql=this.exportTablesInSQL();this.gim_data.innerHTML="";this.gim_data_many_to_many.innerHTML="";this.gim_data_has_many.innerHTML="";this.gim_data_belongs_to.innerHTML="";YAHOO.util.Dom.setStyle(GIM.gim_data_belongs_to,'display','none');YAHOO.util.Dom.setStyle(GIM.gim_data_has_many,'display','none');YAHOO.util.Dom.setStyle(GIM.gim_data_many_to_many,'display','none');var textarea=cn('textarea',{cols:100,rows:30},{marginTop:'4px'},sql);this.gim_data.appendChild(textarea);}};GIM.showLicense=function(){var text="Software License Agreement (New BSD License)<br /><br />"+"Copyright (c) 2007, Eric Abouaf, Samuel Dehouck, Maxime R&eacute;ty<br />"+"All rights reserved.<br /><br />"+"Redistribution and use of this software in source and binary forms, with or without modification, are<br />"+"permitted provided that the following conditions are met:<br /><br />"+"* Redistributions of source code must retain the above<br />"+"  copyright notice, this list of conditions and the<br />"+"  following disclaimer.<br /><br />"+"* Redistributions in binary form must reproduce the above<br />"+"  copyright notice, this list of conditions and the<br />"+"  following disclaimer in the documentation and/or other<br />"+"  materials provided with the distribution.<br /><br />"+"* Neither the name of Yahoo! Inc. nor the names of its<br />"+"  contributors may be used to endorse or promote products<br />"+"  derived from this software without specific prior<br />"+"  written permission of Yahoo! Inc.<br /><br />"+"THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY EXPRESS OR IMPLIED<br />"+"WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A<br />"+"PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR<br />"+"ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT<br />"+"LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<br />"+"INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR<br />"+"TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF<br />"+"ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.";this.gim_data.innerHTML="";this.gim_data_many_to_many.innerHTML="";this.gim_data_has_many.innerHTML="";this.gim_data_belongs_to.innerHTML="";YAHOO.util.Dom.setStyle(GIM.gim_data_belongs_to,'display','none');YAHOO.util.Dom.setStyle(GIM.gim_data_has_many,'display','none');YAHOO.util.Dom.setStyle(GIM.gim_data_many_to_many,'display','none');this.gim_data.innerHTML=text;};YAHOO.widget.DataTable.editTextbox=function(oEditor,oSelf){var elCell=oEditor.cell;var oRecord=oEditor.record;var oColumn=oEditor.column;var elContainer=oEditor.container;var value=YAHOO.lang.isValue(oRecord.getData(oColumn.key))?oRecord.getData(oColumn.key):"";var elTextbox=elContainer.appendChild(document.createElement("input"));elTextbox.type="text";elTextbox.style.width=elCell.offsetWidth+"px";elTextbox.value=value;YAHOO.util.Event.addListener(elTextbox,"keyup",function(v){if(v.keyCode===13){oSelf.saveCellEditor();}
else{oSelf._oCellEditor.value=elTextbox.value;oSelf.fireEvent("editorUpdateEvent",{editor:oSelf._oCellEditor});}});elTextbox.focus();elTextbox.select();};GIM.DataTableBySql=function(query,queryParams,container,tableName){this.query=query;this.queryParams=queryParams;this.container=container;this.tableName=tableName;this.fields=(GIM.listFieldInTable(this.tableName))[1];this.results=GIM.query(query,queryParams);this.minRowsPerPage=10;var configs;if(this.results.length>this.minRowsPerPage){configs={paginated:true,paginator:{dropdownOptions:[this.minRowsPerPage,25,50,100],pageLinks:5,rowsPerPage:this.minRowsPerPage}};}else{configs={};}
var columnHeaders=[];var tab_fields=[];var subFieldsName=[];for(var j=0;j<this.fields.length;j++){var item={key:this.fields[j],label:this.fields[j],sortable:true};if(this.fields[j]!="id")item.editor="textbox";subFieldsName.push(item);tab_fields.push(this.fields[j]);}
columnHeaders.push({label:this.tableName,className:'table-name-header',children:subFieldsName});var dataSource=new YAHOO.util.DataSource(this.results);dataSource.responseType=YAHOO.util.DataSource.TYPE_JSARRAY;dataSource.responseSchema={fields:tab_fields};GIM.DataTableBySql.superclass.constructor.call(this,this.container,columnHeaders,dataSource,configs);new YAHOO.widget.Button({label:"Add a row",id:"addRowButton",container:this.container,onclick:{fn:function(){this.onAddRow();},scope:this}});new YAHOO.widget.Button({label:"Add a column",id:"addColButton",container:this.container,onclick:{fn:function(){this.onAddCol();},scope:this}});var tempId="gim_contextmenu"+Math.floor(Math.random(3000)*2994);this.contextMenu=new YAHOO.widget.ContextMenu(tempId,{zIndex:10,trigger:this.getBody()});this.contextMenu.addItem("View linked items");this.contextMenu.addItem("Delete item");this.contextMenu.render(document.body);YAHOO.util.Dom.addClass(this.contextMenu.element,'gim_contextmenu');this.initEvents();};YAHOO.extend(GIM.DataTableBySql,YAHOO.widget.DataTable);GIM.DataTableBySql.prototype.initEvents=function(){this.subscribe("cellClickEvent",this.onEventShowCellEditor);this.subscribe("editorSaveEvent",this.onCellEdit,this,true);this.contextMenu.clickEvent.subscribe(this.onContextMenuClick,this,true);};GIM.DataTableBySql.prototype.onContextMenuClick=function(p_sType,p_aArgs,p_oMenu){var task=p_aArgs[1];if(!task){return;}
var row=this.contextMenu.contextEventTarget;while(row.tagName.toLowerCase()!="tr"){row=row.parentNode;if(row.tagName.toLowerCase()=="body"){return;}}
var id=parseInt(row.childNodes[0].innerHTML,10);if(task.index==0){GIM.viewElement(id,this.tableName);}
else if(task.index==1){this.onDeleteRow(row);}};GIM.DataTableBySql.prototype.onAddRow=function(){var newId=GIM.getNextAvailableId(this.tableName);var new_row={id:newId};this.addRow(new_row);var questionMarks=[];var queryParams=[];for(var i=0;i<this.fields.length;i++){questionMarks.push('?');queryParams.push("");}
queryParams[0]=newId;try{var query='insert into '+this.tableName+' values('+questionMarks.join(',')+')';GIM.query(query,queryParams);}
catch(e){alert(e);}
this.refreshView();var nPage=(Math.ceil((this.getRecordSet()._length)/this._configs.paginator.value.rowsPerPage))||1;this.showPage(nPage);};GIM.DataTableBySql.prototype.onAddCol=function(){var fieldName=prompt("Field name");if(fieldName===null){return;}
if(fieldName===""){alert('Field must have a name !');return;}
var fieldType=prompt("Field type");if(fieldType===null){return;}
if(fieldType===""){alert('Field type must have a name !');return;}
var query="alter table "+this.tableName+" add "+fieldName+" "+fieldType;GIM.query(query);GIM.displayTableBySql("select * from "+this.tableName,[],this.container,this.tableName);GIM.autoDiscoverLiaisons();};GIM.DataTableBySql.prototype.onEventShowCellEditor=function(oArgs){var evt=oArgs.event;var target=oArgs.target;var elTag=target.tagName.toLowerCase();var elCell=this.getTdEl(target);var realRecordIndex=this.getRecordIndex(elCell)+(this._configs.paginator.value.currentPage-1)*this._configs.paginator.value.rowsPerPage;var oRecord=this.getRecord(realRecordIndex);if(elCell){if(YAHOO.util.Dom.hasClass(elCell,'yui-dt-first')){GIM.viewElement(oRecord._oData.id,this.tableName);}
else{this.showCellEditor(elCell,oRecord);}}
else{}};GIM.DataTableBySql.prototype.onCellEdit=function(oArgs){this.refreshView();if(oArgs.newData===oArgs.oldData){return;}
var td=oArgs.editor.cell;var tr=td.parentNode;var tableEl=tr.parentNode.parentNode;var headRowTable=tableEl.childNodes[0].childNodes[0];var headRowFields=tableEl.childNodes[0].childNodes[1];var index=-1;for(var i=0;i<tr.childNodes.length;i++){if(tr.childNodes[i]===td){index=i;}}
if(index==-1){throw new Error('onCellEdit failure !!!');}
var fieldName=headRowFields.childNodes[index].childNodes[0].childNodes[0].childNodes[0].innerHTML;var tableIndex=-1;for(var i=0;i<headRowTable.childNodes.length;i++){columnNbr=headRowTable.childNodes[i].colSpan;if(columnNbr<index){index=index-columnNbr;}
else{tableIndex=i;break;}}
if(tableIndex==-1){throw new Error('onCellEdit failure !!!');}
var idCell=0;for(var j=0;j<tableIndex;j++){idCell+=headRowTable.childNodes[j].colSpan;}
var elementId=tr.childNodes[idCell].innerHTML;GIM.updateElement(this.tableName,elementId,fieldName,oArgs.newData);GIM.displayTableBySql(this.query,this.queryParams,this.container,this.tableName);if(GIM._dataTableBySql_manytomany&&GIM.gim_data_many_to_many.innerHTML!==""){var title=GIM.gim_data_many_to_many.childNodes[0];GIM.displayTableBySql(GIM._dataTableBySql_manytomany.query,GIM._dataTableBySql_manytomany.queryParams,GIM._dataTableBySql_manytomany.container);var NodeList=GIM.gim_data_many_to_many.getElementsByTagName("span");var position=NodeList.item(0);GIM.gim_data_many_to_many.insertBefore(title,position);}
if(GIM._dataTableBySql_hasmany&&GIM.gim_data_has_many.innerHTML!==""){var title=GIM.gim_data_has_many.childNodes[0];GIM.displayTableBySql(GIM._dataTableBySql_hasmany.query,GIM._dataTableBySql_hasmany.queryParams,GIM._dataTableBySql_hasmany.container);var NodeList=GIM.gim_data_has_many.getElementsByTagName("span");var position=NodeList.item(0);GIM.gim_data_has_many.insertBefore(title,position);}
if(GIM._dataTableBySql_belongsto&&GIM.gim_data_belongs_to.innerHTML!==""){var title=GIM.gim_data_belongs_to.childNodes[0];GIM.displayTableBySql(GIM._dataTableBySql_belongsto.query,GIM._dataTableBySql_belongsto.queryParams,GIM._dataTableBySql_belongsto.container);var NodeList=GIM.gim_data_belongs_to.getElementsByTagName("span");var position=NodeList.item(0);GIM.gim_data_belongs_to.insertBefore(title,position);}};GIM.DataTableBySql.prototype.onDeleteRow=function(row){var ids=[];var tableEl=row.parentNode.parentNode;var headRowFields=tableEl.childNodes[0].childNodes[1];var realRecordIndex=this.getRecordIndex(row)+(this._configs.paginator.value.currentPage-1)*this._configs.paginator.value.rowsPerPage;for(var i=0;i<headRowFields.childNodes.length;i++){if(headRowFields.childNodes[i].childNodes[0].childNodes[0].childNodes[0].innerHTML==="id"){ids.push(row.childNodes[i].innerHTML);}}
if(confirm("Do you want to delete the element of id "+ids[0]+" from the table "+this.tableName+"?")){var query='delete from '+this.tableName+' where id=?';GIM.query(query,[ids[compteur]]);this.deleteRow(realRecordIndex);if(realRecordIndex==(this._configs.paginator.value.currentPage-1)*this._configs.paginator.value.rowsPerPage&&this._configs.paginator.value.currentPage>0){this.showPage(this._configs.paginator.value.currentPage-1);}
this.refreshView();}};GIM.DataTableBySql.prototype._onPaginatorDropdownChange=function(e,oSelf){var elTarget=YAHOO.util.Event.getTarget(e);var newValue=elTarget[elTarget.selectedIndex].value;var newRowsPerPage=YAHOO.lang.isValue(parseInt(newValue,10))?parseInt(newValue,10):null;if(newRowsPerPage!==null){var currentPage=oSelf.get("paginator").currentPage;var nPage=1;if((currentPage-1)*newRowsPerPage<oSelf.getRecordSet()._length){nPage=currentPage;}else{nPage=1;}
oSelf.updatePaginator({rowsPerPage:newRowsPerPage});oSelf.showPage(nPage);oSelf.refreshView();}
else{}};GIM.initDatabase=function(){try{this.db=google.gears.factory.create('beta.database','1.0');}
catch(ex){throw new Error('GIM was unable to init database: '+ex.message);}};GIM.addTable=function(){var tableName=prompt('Enter the new table name');if(tableName===null){return;}
if(tableName===''){alert('Cannot create table without a name.');return;}
var query='create table '+tableName+' (id integer)';try{this.db.execute(query);}
catch(ex){throw new Error('GIM was unable to add table: '+ex.message);}
this.updateMenu();GIM.displayTableBySql("select * from "+tableName,[],GIM.gim_data);GIM.autoDiscoverLiaisons();};GIM.openDatabase=function(dbName){if(this.db&&this.openedDatabase){this.db.close();}
try{this.db.open(dbName);this.openedDatabase=dbName;this.autoDiscoverLiaisons();}
catch(ex){throw new Error('GIM was unable to open database: '+ex.message);}};GIM.query=function(query,queryParams){var table=[];var j=0;try{var resultSet=this.db.execute(query,queryParams);}
catch(ex){throw new Error("GIM.query error: "+ex.message);}
while(resultSet.isValidRow()){table[j]=[];for(var i=0;i<resultSet.fieldCount();i++){table[j][resultSet.fieldName(i)]=resultSet.field(i);}
j++;resultSet.next();}
resultSet.close();return table;};GIM.listTables=function(){return this.query('select * from sqlite_master');};GIM.countTable=function(table){var res=this.query('select count(*) from '+table);return res[0]["count(*)"];};GIM.listFieldInTable=function(tableName){if(!tableName){console.trace();throw new Error("Must provide a tableName");}
var res=this.query('select * from sqlite_master where name=?',[tableName]);var sql=res[0]["sql"];try{var regexpResults=sql.match(/^CREATE TABLE [^ ]*[ ]*\((.*)\)$/);var fieldsAndValues=regexpResults[1].split(',');}
catch(ex){alert("unable to match regexp.");return;}
var fields=[];var simpleFields=[];for(var i=0;i<fieldsAndValues.length;i++){var field=fieldsAndValues[i].replace(/^\s+/,'').replace(/\s+$/,'').split(' ');fields.push([field[0],field[1]]);simpleFields.push(field[0]);}
return[fields,simpleFields];};GIM.insert=function(obj,tableName){var temp=this.listFieldInTable(tableName);var fields=temp[0],simpleFields=temp[1];var queryParams=[];var questionMarks=[];for(var i=0;i<fields.length;i++){var fieldName=fields[i][0];queryParams.push(obj[fieldName]);questionMarks.push('?');}
var query="insert into "+tableName+" values ("+questionMarks.join(',')+")";this.query(query,queryParams);};GIM.exportTablesInSQL=function(){var res=this.query('select * from sqlite_master');var sql_output="";for(var i=0;i<res.length;i++){sql_output+=res[i]['sql']+';\n';var entries=this.query('select * from '+res[i]['name']);for(var k=0;k<entries.length;k++){var queryParams=[];for(var field in entries[k]){if(entries[k].hasOwnProperty(field))
queryParams.push('`'+entries[k][field]+'`');}
var query='insert into '+res[i]['name']+' values ('+queryParams.join(',')+')';sql_output+=query+';\n';}}
return sql_output;};GIM.updateElement=function(tableName,elementId,fieldName,newFieldValue){var query="update "+tableName+" set "+fieldName+"=? where id=?";var queryParams=[newFieldValue,elementId];GIM.query(query,queryParams);};GIM.getNextAvailableId=function(tableName){var currentTable=this.query('select * from '+tableName+' order by id desc');if(currentTable.length===0)return 1;var currentId=currentTable[0]['id'];var nextId=currentId+1;return nextId;};GIM.autoDiscoverLiaisons=function(){var liaisons=[];var tables=this.listTables();var tableNames=[];for(var i=0;i<tables.length;i++){tableNames[i]=tables[i]['name'];}
for(var i=0;i<tables.length;i++){var table=tables[i];var tableName=table['name'];var splittedName=tableName.split('_');if(splittedName.length==2&&tableNames.indexOf(splittedName[0])!=-1&&tableNames.indexOf(splittedName[1])!=-1){if(!liaisons[splittedName[0]]){liaisons[splittedName[0]]=[];}
if(!liaisons[splittedName[1]]){liaisons[splittedName[1]]=[];}
liaisons[splittedName[0]].push(["many_to_many",splittedName[1],tableName]);liaisons[splittedName[1]].push(["many_to_many",splittedName[0],tableName]);}
else{var fields=this.listFieldInTable(tableName)[0];for(var k=0;k<fields.length;k++){var fieldName=fields[k][0];if(fieldName.length>3){if(fieldName.substr(-3,3)=='_id'){var singularDestTable=fieldName.substr(0,fieldName.length-3);var destTable=this.pluralizeTableName(singularDestTable);if(tableNames.indexOf(destTable)!=-1){if(!liaisons[tableName])liaisons[tableName]=[];liaisons[tableName].push(["belongs_to",destTable]);if(!liaisons[destTable])liaisons[destTable]=[];liaisons[destTable].push(["has_many",tableName]);}}}}}}
this.liaisons=liaisons;console.log(this.liaisons);};GIM.pluralizeTableName=function(singularName){if(singularName.substr(-1,1)=='y'){return singularName.substr(0,singularName.length-1)+'ies';}
return singularName+'s';};GIM.singularizeTableName=function(pluralName){if(pluralName.substr(-3,3)=='ies'){return pluralName.substr(0,pluralName.length-3)+'y';}
return pluralName.substr(0,pluralName.length-1);};GIM.dropTable=function(tableName){GIM.query("DROP TABLE IF EXISTS "+tableName+";");};GIM.createTableFromJson=function(tableObj){GIM.dropTable(tableObj.name);var fields=[];for(var fieldName in tableObj.fields){if(tableObj.fields.hasOwnProperty(fieldName)){fields.push(fieldName+" "+tableObj.fields[fieldName]);}}
GIM.query("CREATE TABLE "+tableObj.name+" ("+fields.join(',')+");");};GIM.populateTable=function(tableName,elements){for(var i=0;i<elements.length;i++){GIM.insert(elements[i],tableName);}};GIM.populateDatabase=function(populatedTableList){for(var i=0;i<populatedTableList.length;i++){var populatedTable=populatedTableList[i];this.createTableFromJson(populatedTable);GIM.populateTable(populatedTable.name,populatedTable.elements);if(populatedTable.buildElementDom)GIM.elementDomFunctions[populatedTable.name]=populatedTable.buildElementDom;}};